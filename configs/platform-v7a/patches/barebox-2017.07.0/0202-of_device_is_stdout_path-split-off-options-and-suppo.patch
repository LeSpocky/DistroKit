From: =?UTF-8?q?Uwe=20Kleine-K=C3=B6nig?= <u.kleine-koenig@pengutronix.de>
Date: Wed, 14 Jun 2017 13:30:54 +0200
Subject: [PATCH] of_device_is_stdout_path: split off options and support
 aliases
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Several device trees use something like:

	stdout-path = "serial0:115200n8";

Currently of_device_is_stdout_path fails to do the right thing here
because it expects an absolute node path and no options. So split off
options (everything after the colon) and resolve aliases.

Signed-off-by: Uwe Kleine-KÃ¶nig <u.kleine-koenig@pengutronix.de>
Forwarded: id:20170614180249.12644-1-u.kleine-koenig@pengutronix.de (v2)
---
 drivers/of/base.c | 13 ++++++++++++-
 1 file changed, 12 insertions(+), 1 deletion(-)

diff --git a/drivers/of/base.c b/drivers/of/base.c
index 4241ee189cc5..b6e90f2adb09 100644
--- a/drivers/of/base.c
+++ b/drivers/of/base.c
@@ -2017,6 +2017,8 @@ int of_device_is_stdout_path(struct device_d *dev)
 {
 	struct device_node *dn;
 	const char *name;
+	const char *p;
+	char *q;
 
 	if (!dev->device_node)
 		return 0;
@@ -2028,7 +2030,16 @@ int of_device_is_stdout_path(struct device_d *dev)
 	if (!name)
 		return 0;
 
-	dn = of_find_node_by_path(name);
+	/* This could make use of strchrnul if it were available */
+	p = strchr(name, ':');
+	if (!p)
+		p = name + strlen(name);
+
+	q = xstrndup(name, p - name);
+
+	dn = of_find_node_by_path_or_alias(NULL, q);
+
+	free(q);
 
 	return dn == dev->device_node;
 }
